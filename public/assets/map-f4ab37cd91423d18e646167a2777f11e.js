(function(){var e,t,n,r,i,s,o,u,a;u=0,a=0,e=function(){function e(e,t,n){var r;this.useCase=e,this.gui=t,this.storage=n,t=this.gui,n=this.storage,r=this.useCase,this.after(this.useCase,"createNode",function(e){return n.saveNode(e)}),this.after(this.storage,"nodeSaved",function(e){return r.showNode(e)}),this.after(this.useCase,"showNode",function(e){return t.renderNode(e)}),this.after(this.gui,"newNodePrepared",function(e){return r.createNode(e)}),this.after(this.gui,"nodeCurvesPrepared",function(e){return n.storePath(e)}),this.after(this.gui,"nodeDragStartTrigged",function(e){return n.preparePathsForDrag(e)}),this.after(this.storage,"pathsForDragPreapared",function(e,n){return t.nodeDragEnable(e,n)}),this.after(this.gui,"reDrown",function(e){return n.refreshPathObject(e)}),this.after(this.gui,"newRelation",function(t,n){return e.createRelation(parseInt(t),parseInt(n),"no title")}),this.after(this.useCase,"createRelation",function(e,t,r){return n.saveRelation(e,t,r)}),this.after(this.storage,"relationSaved",function(t){return e.drawRelation(t)}),this.after(this.useCase,"drawRelation",function(e){return t.drawRelation(e)}),this.after(this.gui,"addToRelation",function(e,t){return n.addToRelation(parseInt(e),parseInt(t))}),this.after(this.storage,"newRelationElementSaved",function(e){return r.drawLine(e.label.id,e.elements[1])}),this.after(this.useCase,"drawLine",function(e,n){return t.drawLine(e,n)})}return e.prototype.before=function(e,t,n){return YouAreDaBomb(e,t).before(n)},e.prototype.after=function(e,t,n){return YouAreDaBomb(e,t).after(n)},e.prototype.around=function(e,t,n){return YouAreDaBomb(e,t).around(n)},e}(),o=function(){function e(){}return e.prototype.createNode=function(e){},e.prototype.showNode=function(e){},e.prototype.createRelation=function(e,t,n){},e.prototype.drawRelation=function(e){},e.prototype.drawLine=function(e,t){},e}(),s=function(){function e(){this.nodes=[],this.paths=[],this.relations=[]}return e.prototype.saveNode=function(e){return u++,e.id=u,this.nodeSaved(e)},e.prototype.nodeSaved=function(e){return this.nodes.push(e)},e.prototype.storePath=function(e){return this.paths.push(e)},e.prototype.getNodePaths=function(e){var t,n,r,i,s;n=[],s=this.paths;for(r=0,i=s.length;r<i;r++)t=s[r],(t[0]===e||t[1]===e)&&n.push(t);return n},e.prototype.preparePathsForDrag=function(e){return this.pathsForDragPreapared(e,this.getNodePaths(e))},e.prototype.pathsForDragPreapared=function(e,t){},e.prototype.refreshPathObject=function(e){var t,n,r,i,s;i=this.paths,s=[];for(n=0,r=i.length;n<r;n++)t=i[n],t[0]===e[0]&&t[1]===e[1]?s.push(t[2]=e[2]):s.push(void 0);return s},e.prototype.saveRelation=function(e,t,i){var s,o;return this.getRelation(e,t)?!1:(s=new r(e,t,i),s.id=++a,this.relations.push(s),o=new n("no title",2),this.saveNode(o),s.label=o,this.relationSaved(s))},e.prototype.getRelation=function(e,t){var n,r,i,s;s=this.relations;for(r=0,i=s.length;r<i;r++){n=s[r];if(n.elements[0]===e&&n.elements[1]===t||n.elements[1]===e&&n.elements[0]===t)return n}return!1},e.prototype.getNode=function(e){var t,n,r,i;i=this.nodes;for(n=0,r=i.length;n<r;n++){t=i[n];if(t.id===e)return t}return!1},e.prototype.getRelationByLabel=function(e){var t,n,r,i;i=this.relations;for(n=0,r=i.length;n<r;n++){t=i[n],console.log(t.label.id),console.log(e);if(t.label.id===e)return t}return!1},e.prototype.relationSaved=function(e){return console.log(this.relations)},e.prototype.addToRelation=function(e,t){var n,i,s;return i=this.getRelationByLabel(e),s=i.elements[0],console.log("node_id:"),console.log(t),n=new r(s,t,i.title),n.id=++a,n.label=this.getNode(e),this.relations.push(n),this.newRelationElementSaved(n)},e.prototype.newRelationElementSaved=function(e){return console.log(e)},e}(),n=function(){function e(e,t){t==null&&(t=1),this.type=t,this.title=e,this.id=null,this.relations=[]}return e}(),r=function(){function e(e,t,n){this.id=null,this.title=n,this.elements=[e,t],this.label=null}return e}(),t=function(){function e(){this.messagesBox=$(".messages-box"),this.canvas=$(".map-canvas"),this.control=$(".control-layer"),this.lines=$(".lines-layer"),this.paper=Raphael("draw-paper",$(window).width(),$(window).height()),this.emptySpace=this.lines,this.helloMessage()}return e.prototype.helloMessage=function(){return this.showMessage("System is ready. Feel free to express your minds.")},e.prototype.showMessage=function(e,t){var n,r;return t==null&&(t="notice"),n={content:e,type:t},r=HandlebarsTemplates.message(n),r=$(r),this.messagesBox.append(r),r.fadeIn().delay(4e3).fadeOut()},e.prototype.renderNode=function(e){switch(e.type){case 1:return this.renderStandardNode(e);case 2:return this.renderCategoryLabel(e)}},e.prototype.renderCategoryLabel=function(e){var t,n;return n=document.createElement("div"),t=$("<div></div>"),n=$(n),n.attr("class","map-element map-element-relation-label"),t.attr("class","map-element-container"),t.attr("data-id",e.id),t.attr("data-type",e.type),t.append(n),t.css("top",0),t.css("left",0),n.html(e.title+", #"+e.id),this.appendNode(t,e.relations,e.type)},e.prototype.renderStandardNode=function(e){var t,n;return n=document.createElement("div"),t=$("<div></div>"),n=$(n),n.attr("class","map-element map-element-secondary"),t.attr("class","map-element-container"),t.attr("data-id",e.id),t.attr("data-type",e.type),t.append(n),t.css("top",0),t.css("left",0),n.html(e.title+", #"+e.id),this.appendNode(t,e.relations,e.type)},e.prototype.appendNode=function(e,t,n){return this.canvas.append(e),this.prepareNodeTriggers(e,n),this.prepareNodeDrag(e)},e.prototype.prepareNodeTriggers=function(e){var t,n=this;return t=parseInt(e.attr("data-type")),e.contextmenu(function(r){return t===1&&n.showContextMenu(e),t===2&&n.showRelationMenu(e),!1}),e.dblclick(function(t){return t.preventDefault,n.enableEditMode(e)})},e.prototype.showRelationMenu=function(e){var t,n;return this.hideAllContextMenus(),t=HandlebarsTemplates.relationMenu,n=$("<div></div>"),n.append(t),this.control.append(n),t=n.find(".context-menu"),t.css("left",parseInt(e.css("left"))),t.css("top",parseInt(e.css("top"))),t.fadeIn(300),this.enableMenuHidder(t),this.prepareRelationMenuTriggers(t,e)},e.prototype.prepareNodeDrag=function(e){var t=this;return e.mousedown(function(n){return t.nodeDragStartTrigged(parseInt(e.attr("data-id")))})},e.prototype.nodeDragStartTrigged=function(e){},e.prototype.nodeDragEnable=function(e,t){var n,r=this;return n=this.canvas.find(".map-element-container[data-id="+e+"]"),$(document).mousemove(function(e){return r.oldX=e.pageX,r.oldY=e.pageY,$(document).unbind("mousemove"),$(document).mousemove(function(e){var t,i;return t=e.pageX-r.oldX,i=e.pageY-r.oldY,n.css("top",parseInt(n.css("top"))+i),n.css("left",parseInt(n.css("left"))+t),r.oldX=e.pageX,r.oldY=e.pageY}),$(document).mouseup(function(){var e,n,i,s;$(document).unbind("mousemove"),s=[];for(n=0,i=t.length;n<i;n++)e=t[n],s.push(r.reDraw(r.canvas.find(".map-element-container[data-id="+e[0]+"]"),r.canvas.find(".map-element-container[data-id="+e[1]+"]"),e[2]));return s})})},e.prototype.showContextMenu=function(e){var t,n;return this.hideAllContextMenus(),t=HandlebarsTemplates.contextMenu,n=$("<div></div>"),n.append(t),this.control.append(n),t=n.find(".context-menu"),t.css("left",parseInt(e.css("left"))),t.css("top",parseInt(e.css("top"))),t.fadeIn(300),this.enableMenuHidder(t),this.prepareContextMenuTriggers(t,e)},e.prototype.prepareContextMenuTriggers=function(e,t){var n=this;return e.find(".new-node").click(function(r){return r.preventDefault(),n.prepareNewNode(t.attr("data-id")),e.parent().remove()}),e.find(".remove-node").click(function(r){return r.preventDefault(),n.removeNode(t),e.parent().remove()}),e.find(".new-relation").click(function(r){return r.preventDefault(),e.parent().remove(),n.selectNodeToSetRelation(t.attr("data-id"))})},e.prototype.selectNodeToSetRelation=function(e){var t=this;return this.showMessage("Please select element which you want to be related with."),$(".map-element-container").not("[data-id="+e+"]").hover(function(){return $(this).addClass("highlight")},function(){return $(this).removeClass("highlight")}),$(".map-element-container").not("[data-id="+e+"]").click(function(n){var r;return r=$(n.currentTarget).attr("data-id"),$(".map-element-container").not("[data-id="+e+"]").removeClass("highlight"),$(".map-element-container").not("[data-id="+e+"]").unbind("hover"),$(".map-element-container").not("[data-id="+e+"]").unbind("click"),t.emptySpace.unbind("click"),t.newRelation(e,r)}),this.emptySpace.click(function(n){return $(".map-element-container").not("[data-id="+e+"]").removeClass("highlight"),$(".map-element-container").not("[data-id="+e+"]").unbind("hover"),$(".map-element-container").not("[data-id="+e+"]").unbind("click"),$(t).unbind(n)})},e.prototype.newRelation=function(e,t){},e.prototype.drawRelation=function(e){var t,n,r;return t=parseInt(e.elements[0]),n=parseInt(e.elements[1]),r=parseInt(e.label.id),this.prepareNodeCurves(t,r),this.prepareNodeCurves(n,r)},e.prototype.drawLine=function(e,t){return console.log("gui.drawLine"),console.log(e),console.log(t),this.prepareNodeCurves(e,t)},e.prototype.prepareRelationMenuTriggers=function(e,t){var n=this;return e.find(".select-related").click(function(r){return r.preventDefault(),e.parent().remove(),n.selectNodeToAddToRelation(t.attr("data-id"))})},e.prototype.selectNodeToAddToRelation=function(e){var t=this;return this.showMessage("Please select element which you want to be related with."),$(".map-element-container").not("[data-id="+e+"]").hover(function(){return $(this).addClass("highlight")},function(){return $(this).removeClass("highlight")}),$(".map-element-container").not("[data-id="+e+"]").click(function(n){var r;return r=$(n.currentTarget).attr("data-id"),$(".map-element-container").not("[data-id="+e+"]").removeClass("highlight"),$(".map-element-container").not("[data-id="+e+"]").unbind("hover"),$(".map-element-container").not("[data-id="+e+"]").unbind("click"),t.emptySpace.unbind("click"),t.addToRelation(parseInt(e),parseInt(r))}),this.emptySpace.click(function(n){return $(".map-element-container").not("[data-id="+e+"]").removeClass("highlight"),$(".map-element-container").not("[data-id="+e+"]").unbind("hover"),$(".map-element-container").not("[data-id="+e+"]").unbind("click"),$(t).unbind(n)})},e.prototype.addToRelation=function(e,t){},e.prototype.removeNode=function(e){return e.remove()},e.prototype.hideAllContextMenus=function(){return $(".context-menu").parent().remove()},e.prototype.enableMenuHidder=function(e){var t,n=this;return t=this.emptySpace.click(function(){return e.fadeOut(300,function(){return $(this).remove()})})},e.prototype.prepareNewNode=function(e){var t;return t=new n("node",1),this.newNodePrepared(t)},e.prototype.newNodePrepared=function(e){},e.prototype.fitNodeLayout=function(e){var t,n;return n=e.outerHeight()-e.parent().find("> .map-element").outerHeight(),console.log(n),t=n/2*-1,e.css("bottom",t)},e.prototype.enableEditMode=function(e){var t,n=this;return e.addClass("edit-on"),t=$('<input type="text" class="edit-title" value="'+e.find(".map-element").text()+'" />'),e.find(".map-element").html(t),e.unbind(),t.keydown(function(t){if(t.keyCode===13)return n.disableEditMode(e)}),$(window).click(function(t){return n.disableEditMode(e),$(n).unbind(t)}),e.click(function(e){return e.stopPropagation()})},e.prototype.disableEditMode=function(e){return e.removeClass("edit-on"),e.find(".map-element").html(e.find(".map-element input.edit-title").val()),e.unbind(),this.prepareNodeTriggers(e),this.prepareNodeDrag(e)},e.prototype.prepareNodeCurves=function(e,t){var n,r,i,s,o,u,a;return n=this.canvas.find(".map-element-container[data-id="+e+"]"),i=n.offset().top,r=n.offset().left,s=this.canvas.find(".map-element-container[data-id="+t+"]"),u=s.offset().top,o=s.offset().left,a=this.paper.path("M"+o+" "+u+"L"+r+" "+i),this.nodeCurvesPrepared([e,t,a])},e.prototype.nodeCurvesPrepared=function(e){},e.prototype.reDrown=function(e){},e.prototype.reDraw=function(e,t,n){var r,i,s,o;return n.remove(),i=e.offset().top,r=e.offset().left,o=t.offset().top,s=t.offset().left,n=this.paper.path("M"+s+" "+o+"L"+r+" "+i),this.reDrown([parseInt(e.attr("data-id")),parseInt(t.attr("data-id")),n])},e}(),i=function(){function r(){var r,i,u,a,f,l,c;l=new s,c=new o,i=new t,r=new e(c,i,l),u=new n("Root"),c.createNode(u),a=new n("Second Root"),f=new n("Projekt"),c.createNode(a),c.createNode(f)}return r}(),$(function(){return new i})}).call(this);